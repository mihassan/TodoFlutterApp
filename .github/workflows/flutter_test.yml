name: Flutter CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'

      # Cache pub dependencies
      - name: Cache pub dependencies
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.PUB_CACHE }}
            **/.packages
            **/pubspec.lock
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # Get dependencies
      - name: Get dependencies
        run: |
          cd app
          flutter pub get

      # Run formatter check
      - name: Check formatting
        run: |
          dart format --set-exit-if-changed .
        continue-on-error: false

      # Run analyzer
      - name: Run static analysis
        run: |
          cd app
          flutter analyze
        continue-on-error: false

      # Run unit and widget tests
      - name: Run unit and widget tests
        run: |
          cd app
          flutter test --coverage
        continue-on-error: false

      # (Optional) Upload coverage to codecov
      - name: Upload coverage to codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./app/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
